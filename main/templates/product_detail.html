{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Product Detail</title>
{% endblock meta %}

{% block content %}
<div class="pt-20 min-h-screen bg-gray-50">
  <div class="max-w-5xl mx-auto px-6 py-8">
    <a href="{% url 'main:show_main' %}" class="inline-flex items-center text-blue-600 hover:text-blue-700 font-medium transition-colors mb-6">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
      </svg>
      Back to Product List
    </a>

    <div id="loading-state" class="bg-white rounded-lg shadow-md border border-gray-200 p-12 text-center">
      <svg class="animate-spin h-8 w-8 text-blue-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p class="text-gray-600 mt-3">Loading product details...</p>
    </div>

    <div id="error-state" class="bg-white rounded-lg shadow-md border border-gray-200 p-12 text-center hidden">
      <div class="text-red-500 text-5xl mx-auto mb-4">⚠️</div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">Failed to load product</h3>
      <p class="text-gray-500">The requested product could not be found or an error occurred. Please try again later.</p>
    </div>

    <div id="product-content" class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden hidden">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 p-8">
        <div>
          <div id="product-image-container" class="aspect-square rounded-lg overflow-hidden border border-gray-200 hidden">
            <img id="product-image" src="" alt="" class="w-full h-full object-cover">
          </div>
          <div id="no-image-placeholder" class="aspect-square rounded-lg bg-gray-200 flex items-center justify-center border border-gray-300 hidden">
            <span class="text-gray-400">No image available</span>
          </div>
        </div>

        <div class="flex flex-col">
          <div id="badges-container" class="flex flex-wrap gap-2 mb-4">
          </div>

          <h1 id="product-title" class="text-3xl font-bold text-gray-900 mb-4"></h1>

          <div class="mb-6">
            <p id="product-price" class="text-4xl font-bold text-blue-600"></p>
          </div>

          <div class="bg-gray-50 rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium text-gray-700">Stock Available:</span>
              <span id="product-stock" class="text-lg font-bold"></span>
            </div>
          </div>

          <div class="space-y-3 mb-6 pb-6 border-b border-gray-200">
            <div id="product-created-at" class="flex items-center text-sm text-gray-600"></div>
            <div id="product-views" class="flex items-center text-sm text-gray-600"></div>
            <div id="product-author" class="flex items-center text-sm text-gray-600"></div>
          </div>

          <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-3">Description</h3>
            <p id="product-description" class="text-gray-700 leading-relaxed whitespace-pre-line"></p>
          </div>

          <div id="action-buttons-container" class="flex gap-3 mt-auto">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Configuration
const PRODUCT_ID = "{{ product.id }}";
const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";
const PRODUCT_DETAIL_ENDPOINT = `{% url 'main:show_json_by_id' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', PRODUCT_ID);

// DOM Elements
const loadingState = document.getElementById('loading-state');
const errorState = document.getElementById('error-state');
const productContent = document.getElementById('product-content');

const imageContainer = document.getElementById('product-image-container');
const productImage = document.getElementById('product-image');
const noImagePlaceholder = document.getElementById('no-image-placeholder');

const badgesContainer = document.getElementById('badges-container');
const productTitle = document.getElementById('product-title');
const productPrice = document.getElementById('product-price');
const productStock = document.getElementById('product-stock');

const productCreatedAt = document.getElementById('product-created-at');
const productViews = document.getElementById('product-views');
const productAuthor = document.getElementById('product-author');
const productDescription = document.getElementById('product-description');
const actionButtonsContainer = document.getElementById('action-buttons-container');

// Helper Functions
function showState(state) {
    loadingState.classList.toggle('hidden', state !== 'loading');
    errorState.classList.toggle('hidden', state !== 'error');
    productContent.classList.toggle('hidden', state !== 'ready');
}

function getCategoryLabel(categoryCode) {
    const categoryMapping = {
        apparel: 'Apparel',
        equipment: 'Equipment',
        accessories: 'Accessories',
        fitness: 'Fitness',
        outdoor: 'Outdoor',
        other: 'Other',
    };
    return categoryMapping[categoryCode] || categoryCode;
}

function createBadge(text, classes) {
    const badge = document.createElement('span');
    badge.className = `inline-flex items-center px-3 py-1 rounded-md text-xs font-medium ${classes}`;
    badge.textContent = text;
    return badge;
}

// Main Render Function
function renderProduct(data) {
    // Set document title
    document.title = `${data.name} - Product Detail`;

    // Set image
    if (data.thumbnail) {
        productImage.src = data.thumbnail;
        productImage.alt = data.name;
        imageContainer.classList.remove('hidden');
        noImagePlaceholder.classList.add('hidden');
    } else {
        imageContainer.classList.add('hidden');
        noImagePlaceholder.classList.remove('hidden');
    }

    // Set badges
    badgesContainer.innerHTML = '';
    badgesContainer.appendChild(createBadge(getCategoryLabel(data.category), 'bg-blue-600 text-white'));
    
    if (data.is_featured) {
        badgesContainer.appendChild(createBadge('Featured', 'bg-yellow-100 text-yellow-800'));
    }
    
    if (data.product_views && data.product_views > 20) {
        badgesContainer.appendChild(createBadge('Popular', 'bg-red-100 text-red-800'));
    }
    
    if (data.stock > 0) {
        badgesContainer.appendChild(createBadge('In Stock', 'bg-green-100 text-green-800'));
    } else {
        badgesContainer.appendChild(createBadge('Out of Stock', 'bg-red-100 text-red-800'));
    }

    // Set main details
    productTitle.textContent = data.name;
    productPrice.textContent = `Rp ${parseFloat(data.price).toLocaleString('id-ID')}`;
    productStock.textContent = `${data.stock} units`;
    productStock.className = `text-lg font-bold ${data.stock < 5 ? 'text-red-600' : 'text-gray-900'}`;

    // Set meta info
    const createdAtDate = new Date(data.created_at).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    productCreatedAt.innerHTML = `<span>Created on ${createdAtDate}</span>`;
    productViews.innerHTML = `<span>${data.product_views || 0} views</span>`;
    productAuthor.innerHTML = `<span>Added by <strong>${data.user_username || 'Anonymous'}</strong></span>`;

    // Set description
    productDescription.textContent = data.description;

    // Set action buttons (if user is owner)
    actionButtonsContainer.innerHTML = '';
    if (CURRENT_USER_ID && Number(data.user_id) === Number(CURRENT_USER_ID)) {
        const editUrl = `{% url 'main:edit_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', PRODUCT_ID);
        const deleteUrl = `{% url 'main:delete_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', PRODUCT_ID);

        actionButtonsContainer.innerHTML = `
            <a href="${editUrl}" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg text-center transition-colors">
                Edit Product
            </a>
            <a href="${deleteUrl}" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg text-center transition-colors" 
               onclick="return confirm('Are you sure you want to delete this product?')">
                Delete Product
            </a>
        `;
    }
}

// Fetch Data Function
async function loadProductDetail() {
    try {
        showState('loading');
        
        const response = await fetch(PRODUCT_DETAIL_ENDPOINT, {
            headers: { 'Accept': 'application/json' },
        });

        if (!response.ok) {
            throw new Error('Failed to fetch product detail');
        }

        const productData = await response.json();
        renderProduct(productData);
        showState('ready');
    } catch (error) {
        console.error('Error loading product detail:', error);
        showState('error');
    }
}

// Initialize page
loadProductDetail();
</script>
{% endblock content %}