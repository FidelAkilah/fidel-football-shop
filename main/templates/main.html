{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Sport Shop</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}
<div class="bg-gray-50 w-full pt-16 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Header Section -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white py-8 px-6 rounded-lg shadow-lg mb-8">
      <h1 class="text-4xl font-bold mb-4">Sport Shop</h1>
      
      <div class="bg-white bg-opacity-20 rounded-lg p-4 backdrop-blur-sm">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
          <div>
            <h5 class="font-semibold mb-1">NPM:</h5>
            <p class="text-gray-100">{{ npm }}</p>
          </div>
          <div>
            <h5 class="font-semibold mb-1">Name:</h5>
            <p class="text-gray-100">{{ name }}</p>
          </div>
          <div>
            <h5 class="font-semibold mb-1">Class:</h5>
            <p class="text-gray-100">{{ class }}</p>
          </div>
        </div>
      </div>
      
      {% if user.is_authenticated %}
      <div class="mt-4 text-sm text-gray-200">
        <p>Last login: {{ last_login }}</p>
      </div>
      {% endif %}
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-3 mb-6">
      <button onclick="showModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 shadow-md">
        + Add Product by AJAX
      </button>
      <a href="{% url 'main:create_product' %}" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 shadow-md">
        + Add Product
      </a>
    </div>

    <!-- Filter Section -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 bg-white rounded-lg border border-gray-200 p-4">
      <div class="flex space-x-3 mb-4 sm:mb-0">
        <button id="filter-all" class="bg-blue-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-blue-700">
          All Products
        </button>
        <button id="filter-my" class="bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-medium transition-colors hover:bg-blue-600 hover:text-white">
          My Products
        </button>
      </div>
      {% if user.is_authenticated %}
        <div class="text-sm text-gray-500">Last login: {{ last_login }}</div>
      {% endif %}
    </div>

    <!-- Loading State -->
    <div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
      <svg class="animate-spin h-8 w-8 text-blue-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p class="text-gray-600 mt-3">Loading products...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden"></div>

    <!-- Products Grid -->
    <div id="grid" class="hidden"></div>

    <!-- Empty State -->
    <div id="empty" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
      <div class="w-32 h-32 mx-auto mb-4">
        <img src="{% static 'image/no-products.png' %}" alt="No products available" class="w-full h-full object-contain">
      </div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">No products found</h3>
      <p class="text-gray-500 mb-6">Be the first to add products to the sport shop.</p>
      <button onclick="showModal()" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
        Add Product
      </button>
    </div>
  </div>
</div>

<div id="toast-container" class="fixed top-5 right-5 z-[100] w-full max-w-xs space-y-3">
</div>

{% if messages %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% for message in messages %}
        createToast("{{ message.tags }}", "{{ message|escapejs }}");
    {% endfor %}
});
</script>
{% endif %}

<script src="{% static 'js/custom_toast.js' %}"></script>

{% include 'modal.html' %}

<script>
  // Configuration
  const PRODUCTS_API_ENDPOINT = "{% url 'main:show_json' %}";
  const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";
  
  // DOM Elements
  const loadingSpinner = document.getElementById('loading');
  const errorMessage = document.getElementById('error');
  const emptyStateDisplay = document.getElementById('empty');
  const productGridContainer = document.getElementById('grid');
  const showAllButton = document.getElementById('filter-all');
  const showMyButton = document.getElementById('filter-my');
  
  // State Variables
  let activeFilter = 'all';
  let allProductsData = [];
  
  // Update filter button appearance
  function updateFilterButtonsAppearance() {
    if (!showAllButton || !showMyButton) return;
    
    if (activeFilter === 'all') {
      showAllButton.className = 'bg-blue-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-blue-700';
      showMyButton.className = 'bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-medium transition-colors hover:bg-blue-600 hover:text-white';
    } else {
      showMyButton.className = 'bg-blue-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-blue-700';
      showAllButton.className = 'bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-medium transition-colors hover:bg-blue-600 hover:text-white';
    }
  }
  
  // Show/hide page sections
  function displayPageSection({ showLoading = false, showError = false, showEmpty = false, showGrid = false }) {
    loadingSpinner.classList.toggle('hidden', !showLoading);
    errorMessage.classList.toggle('hidden', !showError);
    emptyStateDisplay.classList.toggle('hidden', !showEmpty);
    productGridContainer.classList.toggle('hidden', !showGrid);
    
    if (showGrid) {
      productGridContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
    }
  }
  
  // Get readable category name
  function getReadableCategoryName(categoryCode) {
    const categoryMapping = {
      apparel: 'Apparel',
      equipment: 'Equipment',
      accessories: 'Accessories',
      fitness: 'Fitness',
      outdoor: 'Outdoor',
      other: 'Other',
    };
    return categoryMapping[categoryCode] || categoryCode;
  }
  
  // Create product card element
  function buildProductCardElement(product) {
    const article = document.createElement('article');
    article.className = 'bg-white rounded-lg border border-gray-200 hover:shadow-lg transition-shadow duration-300 overflow-hidden flex flex-col h-full';

    // Check if data is in Django serialized format (with pk and fields)
    const item = product.fields ? product.fields : product;
    const productId = product.pk || product.id;

    const linkDetail = `{% url 'main:show_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', productId);
    const linkEdit = `{% url 'main:edit_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', productId);
    const linkDelete = `{% url 'main:delete_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', productId);

    const name = DOMPurify.sanitize(item.name);
    const description = DOMPurify.sanitize(item.description);
    const price = DOMPurify.sanitize(item.price);
    const stock = DOMPurify.sanitize(item.stock);
    const category = DOMPurify.sanitize(item.category);
    const thumbnail = item.thumbnail ? DOMPurify.sanitize(item.thumbnail) : '';
    const productViews = DOMPurify.sanitize(item.product_views || 0);
    const isFeatured = item.is_featured;
    const isPopular = productViews > 20;
    const userId = item.user || item.user_id;

    const thumbnailHtml = thumbnail 
      ? `<img src='${thumbnail}' alt='${name}' class='w-full h-full object-cover'>`
      : `<div class='w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center'>
           <span class='text-gray-400 text-sm'>No Image</span>
         </div>`;
    
    const categoryLabel = DOMPurify.sanitize(getReadableCategoryName(category));
    const featuredLabel = isFeatured ? `<span class='inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800'>Featured</span>` : '';
    const popularLabel = isPopular ? `<span class='inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800'>Popular</span>` : '';

    const editDeleteHtml = CURRENT_USER_ID && Number(CURRENT_USER_ID) === Number(userId)
      ? `<div class='flex space-x-2'>
          <a href='${linkEdit}' class='text-gray-600 hover:text-gray-700 text-sm transition-colors'>Edit</a>
          <a href='${linkDelete}' class='text-red-600 hover:text-red-700 text-sm transition-colors' onclick='return confirm("Are you sure you want to delete this product?")'>Delete</a>
        </div>`
      : '';

    const cardHtml = `
      <div class="aspect-[16/9] relative overflow-hidden">
        ${thumbnailHtml}
        <div class="absolute top-3 left-3">
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-blue-600 text-white">${categoryLabel}</span>
        </div>
        <div class="absolute top-3 right-3 flex flex-col space-y-2">
          ${featuredLabel}
          ${popularLabel}
        </div>
      </div>
      <div class="p-5 flex flex-col flex-1">
        <div class="flex items-center text-sm text-gray-500 mb-3">
          <span>${productViews} views</span>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-3 line-clamp-2 leading-tight">
          <a href="${linkDetail}" class="hover:text-blue-600 transition-colors">${name}</a>
        </h3>
        <div class="flex items-center justify-between mb-3">
          <p class="text-xl font-bold text-blue-600">Rp ${parseFloat(price).toLocaleString('id-ID')}</p>
          <p class="text-sm text-gray-600">Stock: <span class="font-semibold">${stock}</span></p>
        </div>
        <p class="text-gray-600 text-sm leading-relaxed line-clamp-3 mb-4">${description}</p>
        <div class="pt-4 border-t border-gray-100 flex items-center justify-between">
          <a href="${linkDetail}" class="text-blue-600 hover:text-blue-700 font-medium text-sm transition-colors">View Details</a>
          ${editDeleteHtml}
        </div>
      </div>
    `;
    
    article.innerHTML = cardHtml;
    return article;
  }
  
  // Render all product cards
  function renderAllProductCards(products) {
    productGridContainer.innerHTML = '';
    products.forEach(product => {
      const cardElement = buildProductCardElement(product);
      productGridContainer.appendChild(cardElement);
    });
  }
  
  // Filter and display products
  function filterAndDisplayProducts() {
    updateFilterButtonsAppearance();
    
    // For Django serialized format, we need to check the fields property
    const filteredProducts = activeFilter === 'all' 
      ? allProductsData 
      : allProductsData.filter(product => {
          const userId = product.fields ? product.fields.user : product.user_id;
          return Number(userId) === Number(CURRENT_USER_ID);
        });
    
    if (filteredProducts.length === 0) {
      displayPageSection({ showEmpty: true });
    } else {
      renderAllProductCards(filteredProducts);
      displayPageSection({ showGrid: true });
    }
  }
  
  // Fetch products from server
  async function fetchProductsFromServer() {
    try {
      displayPageSection({ showLoading: true });
      
      const response = await fetch(PRODUCTS_API_ENDPOINT, {
        headers: { 'Accept': 'application/json' },
      });
  
      if (!response.ok) {
        throw new Error('Failed to fetch products from server');
      }
  
      const productsData = await response.json();
      
      // Debug: Log the data structure to console
      console.log('Fetched products data:', productsData);
      if (productsData && productsData.length > 0) {
        console.log('First product structure:', productsData[0]);
      }
      
      allProductsData = productsData || [];
      
      filterAndDisplayProducts();
    } catch (error) {
      console.error('Error loading products:', error);
      displayPageSection({ showError: true });
    }
  }
  
  // Event handlers
  function handleShowAllClick() {
    activeFilter = 'all';
    filterAndDisplayProducts();
  }
  
  function handleShowMyClick() {
    activeFilter = 'my';
    filterAndDisplayProducts();
  }
  
  // Initialize page
  function initializeProductsPage() {
    showAllButton.addEventListener('click', handleShowAllClick);
    showMyButton.addEventListener('click', handleShowMyClick);
    
    fetchProductsFromServer();
  }
  
  // Listen for product added event from modal
  document.addEventListener('productAdded', function() {
    fetchProductsFromServer();
  });
  
  // Start application
  initializeProductsPage();
</script>
{% endblock content %}